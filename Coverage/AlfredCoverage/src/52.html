<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\alfred\alfred\matteland.ani.alfred.aiml\aimlstatementhandler.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// ---------------------------------------------------------
// AimlStatementHandler.cs
// 
// Created on:      08/10/2015 at 12:51 AM
// Last Modified:   08/16/2015 at 11:49 PM
// 
// Last Modified by: Matt Eland
// ---------------------------------------------------------

using System;
using System.ComponentModel;
using System.Diagnostics;
using System.Diagnostics.CodeAnalysis;
using System.Globalization;
using System.IO;
using System.Runtime.CompilerServices;
using System.Security;
using System.Xml;

using JetBrains.Annotations;

using MattEland.Ani.Alfred.Chat.Aiml;
using MattEland.Ani.Alfred.Core.Console;
using MattEland.Ani.Alfred.Core.Definitions;
using MattEland.Common;

namespace MattEland.Ani.Alfred.Chat
{
    /// &lt;summary&gt;
    ///     Handles user statements by parsing the statement through an open source AIML engine
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    ///     AIML stands for Artificial Intelligence Markup Language
    /// &lt;/remarks&gt;
    public sealed class AimlStatementHandler : IChatProvider, INotifyPropertyChanged
    {
        [CanBeNull]
        private readonly ChatEngine _chatEngine;

        [CanBeNull]
        private readonly User _user;

        [CanBeNull]
        private IConsole _console;

        [CanBeNull]
        private string _input;

        private UserStatementResponse _response;

        /// &lt;summary&gt;
        ///     Initializes a new instance of the &lt;see cref=&quot;T:System.Object&quot; /&gt; class using the current
        ///     directory for the settings path.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;console&quot;&gt;The console.&lt;/param&gt;
        /// &lt;exception cref=&quot;IOException&quot;&gt;An I/O error occurred.&lt;/exception&gt;
        /// &lt;exception cref=&quot;DirectoryNotFoundException&quot;&gt;Attempted to set a local path that cannot be found.&lt;/exception&gt;
        /// &lt;exception cref=&quot;SecurityException&quot;&gt;The caller does not have the appropriate permission.&lt;/exception&gt;
        public AimlStatementHandler([CanBeNull] IConsole console = null)
            : this(console, Path.Combine(Environment.CurrentDirectory, @&quot;Chat\config&quot;))
        {
        }

        /// &lt;summary&gt;
        ///     Initializes a new instance of the &lt;see cref=&quot;T:System.Object&quot; /&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;console&quot;&gt;The console.&lt;/param&gt;
        /// &lt;param name=&quot;settingsDirectoryPath&quot;&gt;The settings path.&lt;/param&gt;
        /// &lt;exception cref=&quot;System.ArgumentException&quot;&gt;&lt;/exception&gt;
        /// &lt;exception cref=&quot;ArgumentException&quot;&gt;settingsPath, aimlDirectoryPath&lt;/exception&gt;
        public AimlStatementHandler([CanBeNull] IConsole console,
                                    [CanBeNull] string settingsDirectoryPath)
        {
            //- Validate / Store Settings
            if (string.IsNullOrWhiteSpace(settingsDirectoryPath))
            {
                throw new ArgumentException(Resources.NoSettingsPathError,
                                            nameof(settingsDirectoryPath));
            }

            SettingsDirectoryPath = settingsDirectoryPath;

            //- Logging Housekeeping
            _console = console;

            //+ Set up the chat engine
            try
            {
                _chatEngine = new ChatEngine(console);
                _user = new User(Resources.ChatUserName.NonNull(), _chatEngine);
                InitializeChatEngine();
            }
            catch (IOException ex)
            {
                LogErrorInitializingChat(ex);
            }
            catch (SecurityException ex)
            {
                LogErrorInitializingChat(ex);
            }

        }

        /// &lt;summary&gt;
        ///     Gets or sets the settings path.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The settings path.&lt;/value&gt;
        [NotNull]
        public string SettingsDirectoryPath { get; set; }

        /// &lt;summary&gt;
        ///     Gets or sets the console.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The console.&lt;/value&gt;
        [CanBeNull]
        public IConsole Console
        {
            [DebuggerStepThrough]
            [UsedImplicitly]
            get
            {
                return _console;
            }
            [DebuggerStepThrough]
            set
            {
                if (Equals(value, _console))
                {
                    return;
                }

                _console = value;
                OnPropertyChanged();
            }
        }

        /// &lt;summary&gt;
        ///     Gets the chat engine.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;This is present largely for testing&lt;/remarks&gt;
        /// &lt;value&gt;The chat engine.&lt;/value&gt;
        [CanBeNull]
        public ChatEngine ChatEngine
        {
            get { return _chatEngine; }
        }

        /// &lt;summary&gt;
        ///     Handles a user statement.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;userInput&quot;&gt;The user input.&lt;/param&gt;
        /// &lt;returns&gt;The response to the user statement&lt;/returns&gt;
        /// &lt;exception cref=&quot;InvalidOperationException&quot;&gt;
        ///     Cannot use the chat system when chat did not initialize
        ///     properly
        /// &lt;/exception&gt;
        public UserStatementResponse HandleUserStatement(string userInput)
        {
            if (_chatEngine == null || _user == null)
            {
                throw new InvalidOperationException(Resources.AimlStatementHandlerChatOffline);
            }

            //- Log the input to the diagnostic log.
            Console?.Log(Resources.ChatInputHeader, userInput, LogLevel.UserInput);

            // Give our input to the chat ChatEngine
            var result = GetChatResult(userInput);

            //- If it&#39;s a catastrophic failure, return a blankish object
            if (result == null)
            {
                return new UserStatementResponse(userInput, Resources.DefaultFailureResponseText, string.Empty, ChatCommand.Empty);
            }

            // Get the template out of the response so we can see if there are any OOB instructions
            var template = AimlCommandParser.GetResponseTemplate(result);

            // Grab the command from the template, if one was present
            var command = AimlCommandParser.GetCommandFromTemplate(template, Console);

            // Interpret the response 
            var output = result.Output;
            if (!string.IsNullOrWhiteSpace(output))
            {
                Console?.Log(Resources.ChatOutputHeader, output, LogLevel.ChatResponse);
            }

            //- Log the output to the diagnostic log. Sometimes - for redirect commands / etc. there&#39;s no response
            if (!string.IsNullOrWhiteSpace(template))
            {
                Console?.Log(Resources.ChatOutputHeader,
                              string.Format(CultureInfo.CurrentCulture,
                                            &quot;Using Template: {0}&quot;,
                                            template),
                              LogLevel.Verbose);
            }

            //- Update query properties and return the result
            var response = new UserStatementResponse(userInput, output, template, command);
            LastResponse = response;
            LastInput = userInput;

            return response;
        }

        /// &lt;summary&gt;
        ///     Gets the last response from the system.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The last response.&lt;/value&gt;
        [CanBeNull]
        public UserStatementResponse LastResponse
        {
            get { return _response; }
            private set
            {
                if (Equals(value, _response))
                {
                    return;
                }
                _response = value;
                OnPropertyChanged();
            }
        }

        /// &lt;summary&gt;
        ///     Gets the last input from the user.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The last input.&lt;/value&gt;
        [CanBeNull]
        public string LastInput
        {
            get { return _input; }
            private set
            {
                if (value == _input)
                {
                    return;
                }
                _input = value;
                OnPropertyChanged();
            }
        }

        /// &lt;summary&gt;
        ///     Performs an initial greeting by sending hi to the conversation system
        ///     and erasing it from the last input so the user sees Alfred greeting them.
        /// &lt;/summary&gt;
        public void DoInitialGreeting()
        {
            // Send a &quot;hi&quot; into the system
            HandleUserStatement(Resources.InitialGreetingText.NonNull());

            // Clear out the input so it doesn&#39;t look like the user typed it
            LastInput = string.Empty;
        }

        /// &lt;summary&gt;
        ///     Occurs when a property changes.
        /// &lt;/summary&gt;
        public event PropertyChangedEventHandler PropertyChanged;

        /// &lt;summary&gt;
        ///     Logs an error encountered initializing chat.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;ex&quot;&gt;The ex.&lt;/param&gt;
        private void LogErrorInitializingChat([CanBeNull] Exception ex)
        {
            var errorFormat = Resources.ErrorInitializingChat;
            var message = string.Format(CultureInfo.CurrentCulture, errorFormat, ex?.Message);
            _console?.Log(Resources.ChatProcessingHeader, message, LogLevel.Error);
        }

        /// &lt;summary&gt;
        ///     Gets the chat result.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;userInput&quot;&gt;The user input.&lt;/param&gt;
        /// &lt;returns&gt;The result of the communication to the chat ChatEngine&lt;/returns&gt;
        [CanBeNull]
        private Result GetChatResult([NotNull] string userInput)
        {
            if (_chatEngine == null || _user == null)
            {
                throw new InvalidOperationException(Resources.AimlStatementHandlerChatOffline);
            }

            var result = _chatEngine.Chat(userInput, _user);

            return result;
        }

        /// &lt;summary&gt;
        ///     Sets up the chat engine
        /// &lt;/summary&gt;
        private void InitializeChatEngine()
        {
            if (_chatEngine == null || _user == null)
            {
                throw new InvalidOperationException(Resources.AimlStatementHandlerChatOffline);
            }

            _chatEngine.LoadSettingsFromXml(Resources.ChatBotSettings, Resources.ChatBotPersonSubstitutions, Resources.ChatBotPerson2Substitutions, Resources.ChatBotGenderSubstitutions, Resources.ChatBotSubstitutions);

            AddApplicationAimlResourcesToChatEngine(_chatEngine);
        }

        /// &lt;summary&gt;
        ///     Adds Alfred application AIML resources to the chat engine from the internal resource files.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        ///     This method is public and static so that it can be easily accessed by testing libraries.
        /// &lt;/remarks&gt;
        /// &lt;param name=&quot;engine&quot;&gt;The chat engine.&lt;/param&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;
        ///     &lt;paramref name=&quot;engine&quot; /&gt; is &lt;see langword=&quot;null&quot; /&gt;.
        /// &lt;/exception&gt;
        /// &lt;exception cref=&quot;XmlException&quot;&gt;
        ///     There is a load or parse error in the XML. In this case, a
        ///     &lt;see cref=&quot;T:System.IO.FileNotFoundException&quot; /&gt; is raised.
        /// &lt;/exception&gt;
        [SuppressMessage(&quot;ReSharper&quot;, &quot;AssignNullToNotNullAttribute&quot;)]
        public static void AddApplicationAimlResourcesToChatEngine([NotNull] ChatEngine engine)
        {
            if (engine == null)
            {
                throw new ArgumentNullException(nameof(engine));
            }

            engine.LoadAimlFromString(Resources.AimlCoreDateTime);
            engine.LoadAimlFromString(Resources.AimlCorePower);
            engine.LoadAimlFromString(Resources.AimlFallback);
            engine.LoadAimlFromString(Resources.AimlGod);
            engine.LoadAimlFromString(Resources.AimlGreeting);
            engine.LoadAimlFromString(Resources.AimlThanks);
            engine.LoadAimlFromString(Resources.AimlHelp);
            engine.LoadAimlFromString(Resources.AimlShellNavigation);
        }

        /// &lt;summary&gt;
        ///     Called when a property changes.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;propertyName&quot;&gt;Name of the property.&lt;/param&gt;
        [SuppressMessage(&quot;Microsoft.Design&quot;, &quot;CA1026:DefaultParametersShouldNotBeUsed&quot;,
            Justification =
                &quot;Using CallerMemberName to auto-default this value from any property caller&quot;)]
        [NotifyPropertyChangedInvocator]
        private void OnPropertyChanged([CallerMemberName] string propertyName = null)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }

}
    </pre>
    <script type="text/javascript">
      highlightRanges([[76,13,76,14,0],[77,17,78,76,0],[93,13,93,35,0],[94,13,94,14,0],[95,17,95,46,0],[96,13,96,14,0],[97,13,97,41,0],[98,13,98,14,0],[99,17,99,46,0],[100,13,100,14,0],[109,47,109,51,0],[126,13,126,14,0],[127,17,127,45,0],[128,17,128,18,0],[129,21,129,28,0],[132,17,132,34,0],[133,17,133,37,0],[134,13,134,14,0],[160,13,160,14,0],[161,17,161,96,0],[172,13,172,14,0],[173,17,173,132,0],[214,17,214,18,0],[214,19,214,36,0],[214,37,214,38,0],[218,17,218,18,0],[219,21,219,28,0],[237,17,237,18,0],[238,21,238,28,0],[268,9,268,10,0],[269,13,269,63,0],[270,13,270,95,0],[271,13,271,84,0],[272,9,272,10,0],[283,13,283,14,0],[284,17,284,96,0],[298,13,298,14,0],[299,17,299,96,0],[325,13,325,14,0],[326,17,326,65,0],[60,15,60,88,1],[61,9,61,10,1],[62,9,62,10,1],[71,9,72,78,1],[73,9,73,10,1],[75,13,75,66,1],[81,13,81,59,1],[84,13,84,32,1],[88,13,88,14,1],[89,17,89,55,1],[90,17,90,81,1],[91,17,91,40,1],[92,13,92,14,1],[102,9,102,10,1],[109,52,109,56,1],[121,13,121,14,1],[122,17,122,33,1],[123,13,123,14,1],[145,17,145,18,1],[145,19,145,38,1],[145,39,145,40,1],[158,9,158,10,1],[159,13,159,54,1],[165,13,165,84,1],[168,13,168,51,1],[171,13,171,32,1],[177,13,177,74,1],[180,13,180,87,1],[183,13,183,40,1],[184,13,184,52,1],[185,13,185,14,1],[186,17,186,89,1],[187,13,187,14,1],[190,13,190,54,1],[191,13,191,14,1],[192,17,196,49,1],[197,13,197,14,1],[200,13,200,92,1],[201,13,201,37,1],[202,13,202,35,1],[204,13,204,29,1],[205,9,205,10,1],[216,13,216,14,1],[217,17,217,46,1],[221,17,221,35,1],[222,17,222,37,1],[223,13,223,14,1],[233,17,233,18,1],[233,19,233,33,1],[233,34,233,35,1],[235,13,235,14,1],[236,17,236,37,1],[240,17,240,32,1],[241,17,241,37,1],[242,13,242,14,1],[250,9,250,10,1],[252,13,252,74,1],[255,13,255,38,1],[256,9,256,10,1],[281,9,281,10,1],[282,13,282,54,1],[287,13,287,61,1],[289,13,289,27,1],[290,9,290,10,1],[296,9,296,10,1],[297,13,297,54,1],[302,13,302,219,1],[304,13,304,66,1],[305,9,305,10,1],[323,9,323,10,1],[324,13,324,32,1],[329,13,329,67,1],[330,13,330,64,1],[331,13,331,63,1],[332,13,332,58,1],[333,13,333,63,1],[334,13,334,61,1],[335,13,335,59,1],[336,13,336,70,1],[337,9,337,10,1],[348,9,348,10,1],[349,13,349,87,1],[350,9,350,10,1]]);
    </script>
  </body>
</html>