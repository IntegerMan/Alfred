<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\alfred\alfred\matteland.ani.alfred.core\commanddispatcher.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// ---------------------------------------------------------
// CommandDispatcher.cs
// 
// Created on:      08/12/2015 at 1:38 AM
// Last Modified:   08/12/2015 at 1:38 AM
// Original author: Matt Eland
// ---------------------------------------------------------

using System.Globalization;
using System.Linq;

using JetBrains.Annotations;

using MattEland.Ani.Alfred.Core.Console;
using MattEland.Ani.Alfred.Core.Definitions;

namespace MattEland.Ani.Alfred.Core
{
    /// &lt;summary&gt;
    /// A utility class structured around routing UserStatementResponses containing commands to their intended 
    /// subsystems and to return the result of those operations to the caller
    /// &lt;/summary&gt;
    internal static class CommandDispatcher
    {
        /// &lt;summary&gt;
        /// Handles a chat command by dispatching it to the appropriate subsystem(s) and returning the end result.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;response&quot;&gt;The response.&lt;/param&gt;
        /// &lt;param name=&quot;alfred&quot;&gt;The alfred.&lt;/param&gt;
        /// &lt;returns&gt;A result of the chat activity&lt;/returns&gt;
        [NotNull]
        internal static AlfredCommandResult HandleChatCommand(UserStatementResponse response, [NotNull] IAlfred alfred)
        {
            var command = response.Command;

            //- Do nothing with empty commands
            var defaultResult = BuildDefaultCommandResult(response);
            if (command == ChatCommand.Empty)
            {
                return defaultResult;
            }

            //- Extract and normalize the destination ID this message is intended for
            var dest = command.Subsystem?.ToUpperInvariant();

            //- Sanity check to ensure the tag specified a command
            if (string.IsNullOrWhiteSpace(command.Command))
            {
                alfred.Console?.Log(&quot;Chat.Routing&quot;,
                                    &quot;Encountered a command without a command name. Ignoring.&quot;,
                                    LogLevel.Warning);

                return defaultResult;
            }

            // Route the command and get back results
            AlfredCommandResult result;
            if (string.IsNullOrWhiteSpace(dest) &amp;&amp; dest != &quot;ALL&quot;)
            {
                // If this is intended for a specific subsystem, only route it to that subsystem
                result = GetDirectedCommandResult(response, command, alfred);
            }
            else
            {
                // Otherwise this must be a broadcast message and should be sent to each subsystem in turn
                result = GetBroadcastCommandResult(response, command, alfred);
            }

            //- null values become default
            return result ?? defaultResult;
        }

        /// &lt;summary&gt;
        ///     Gets the result of a broadcast command.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;response&quot;&gt;The response.&lt;/param&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command.&lt;/param&gt;
        /// &lt;param name=&quot;alfred&quot;&gt;The alfred instance.&lt;/param&gt;
        /// &lt;returns&gt;MattEland.Ani.Alfred.Core.AlfredCommandResult.&lt;/returns&gt;
        private static AlfredCommandResult GetBroadcastCommandResult(UserStatementResponse response,
                                                                     ChatCommand command,
                                                                     [NotNull] IAlfred alfred)
        {
            // This wasn&#39;t intended for a particular system. Send it to each subsystem
            foreach (var subsystem in alfred.Subsystems)
            {
                // Make sure each subsystem gets a pristine result object.
                var result = BuildDefaultCommandResult(response);
                if (subsystem.HandleChatCommand(command, result))
                {
                    alfred.Console?.Log(&quot;Chat.Routing&quot;,
                                        string.Format(CultureInfo.CurrentCulture,
                                                      &quot;Command {0} was handled by {1}&quot;,
                                                      command.Command,
                                                      subsystem.Name),
                                        LogLevel.Info);

                    return result;
                }
            }

            // No subsystem took it. Log and move on.
            alfred.Console?.Log(&quot;Chat.Routing&quot;,
                                string.Format(CultureInfo.CurrentCulture,
                                              &quot;Command {0} went unhandled by all subsystems&quot;,
                                              command.Command),
                                LogLevel.Warning);
            return null;
        }

        /// &lt;summary&gt;
        ///     Gets the result of a command directed to a single subsystem.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;response&quot;&gt;The response.&lt;/param&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command.&lt;/param&gt;
        /// &lt;param name=&quot;alfred&quot;&gt;The Alfred instance&lt;/param&gt;
        /// &lt;returns&gt;The result.&lt;/returns&gt;
        [CanBeNull]
        private static AlfredCommandResult GetDirectedCommandResult(UserStatementResponse response,
                                                                    ChatCommand command,
                                                                    [NotNull] IAlfred alfred)
        {
            // Find the subsystem matching the one in the command
            var id = command.Subsystem?.ToUpperInvariant();
            var subsystem = alfred.Subsystems.FirstOrDefault(s =&gt; s.Id.ToUpperInvariant() == id);

            // It&#39;s possible to specify something bogus. Shield against that
            if (subsystem == null)
            {
                alfred.Console?.Log(&quot;Chat.Routing&quot;,
                                    &quot;Could not find a target subsystem with an Id of &quot; + id,
                                    LogLevel.Warning);

                return null;
            }

            // Send the command to the subsystem
            var result = BuildDefaultCommandResult(response);
            if (subsystem.HandleChatCommand(command, result))
            {
                alfred.Console?.Log(&quot;Chat.Routing&quot;,
                                    string.Format(CultureInfo.CurrentCulture,
                                                  &quot;Command {0} was handled by {1}&quot;,
                                                  command.Command,
                                                  subsystem.Name),
                                    LogLevel.Info);

                return result;
            }

            // It&#39;s also possible that the subsystem didn&#39;t handle it.
            // In that case log it and we&#39;ll go with the defaults.
            alfred.Console?.Log(&quot;Chat.Routing&quot;,
                                string.Format(CultureInfo.CurrentCulture,
                                              &quot;Command {0} was directed to {1} but went unhandled&quot;,
                                              command.Command,
                                              subsystem.Name),
                                LogLevel.Info);

            return null;
        }

        /// &lt;summary&gt;
        ///     Builds the default command result from a given response.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;response&quot;&gt;The response.&lt;/param&gt;
        /// &lt;returns&gt;The command result.&lt;/returns&gt;
        [NotNull]
        private static AlfredCommandResult BuildDefaultCommandResult(UserStatementResponse response)
        {
            return new AlfredCommandResult
            {
                NewLastInput = response.UserInput,
                NewLastOutput = response.ResponseText,
                RedirectToChat = null
            };
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[33,9,33,10,0],[34,13,34,44,0],[37,13,37,69,0],[38,13,38,46,0],[39,13,39,14,0],[40,17,40,38,0],[44,13,44,62,0],[47,13,47,60,0],[48,13,48,14,0],[49,17,51,55,0],[53,17,53,38,0],[58,13,58,66,0],[59,13,59,14,0],[61,17,61,78,0],[62,13,62,14,0],[64,13,64,14,0],[66,17,66,79,0],[67,13,67,14,0],[70,13,70,44,0],[71,9,71,10,0],[83,9,83,10,0],[85,13,85,20,0],[85,39,85,56,0],[85,22,85,35,0],[86,13,86,14,0],[88,17,88,66,0],[89,17,89,66,0],[90,17,90,18,0],[91,21,96,56,0],[98,21,98,35,0],[100,13,100,14,0],[85,36,85,38,0],[103,13,107,51,0],[108,13,108,25,0],[109,9,109,10,0],[122,9,122,10,0],[124,13,124,60,0],[125,13,125,67,0],[125,96,125,98,0],[128,13,128,35,0],[129,13,129,14,0],[130,17,132,55,0],[134,17,134,29,0],[138,13,138,62,0],[139,13,139,62,0],[140,13,140,14,0],[141,17,146,52,0],[148,17,148,31,0],[153,13,158,48,0],[160,13,160,25,0],[161,9,161,10,0],[170,9,170,10,0],[171,13,176,15,0],[177,9,177,10,0],[125,67,125,96,0]]);
    </script>
  </body>
</html>