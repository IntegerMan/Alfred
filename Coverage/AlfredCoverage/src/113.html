<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\alfred\matteland.ani.alfred.aiml\alfredtaghandler.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// ---------------------------------------------------------
// AlfredTagHandler.cs
// 
// Created on:      08/17/2015 at 10:57 PM
// Last Modified:   08/18/2015 at 1:03 AM
// 
// Last Modified by: Matt Eland
// ---------------------------------------------------------

using System;
using System.Xml;

using JetBrains.Annotations;

using MattEland.Ani.Alfred.Chat.Aiml.TagHandlers;
using MattEland.Ani.Alfred.Chat.Aiml.Utils;
using MattEland.Ani.Alfred.Core;
using MattEland.Ani.Alfred.Core.Console;
using MattEland.Ani.Alfred.Core.Definitions;
using MattEland.Common;

namespace MattEland.Ani.Alfred.Chat
{
    /// &lt;summary&gt;
    /// A TagHandler able to invoke shell events
    /// &lt;/summary&gt;
    [HandlesAimlTag(&quot;shell&quot;)]
    public sealed class ShellTagHandler : AimlTagHandler
    {

        /// &lt;summary&gt;
        ///     Initializes a new instance of the &lt;see cref=&quot;ShellTagHandler&quot; /&gt; class.
        /// &lt;/summary&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;&lt;paramref name=&quot;parameters&quot;/&gt; is &lt;see langword=&quot;null&quot; /&gt;.&lt;/exception&gt;
        public ShellTagHandler([NotNull] TagHandlerParameters parameters) : base(parameters)
        {
        }

        /// &lt;summary&gt;
        ///     Processes the input text and returns the processed value.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The processed output&lt;/returns&gt;
        protected override string ProcessChange()
        {
            var element = TemplateElement;
            var recipient = ChatEngine.Owner as IShellCommandRecipient;

            // If there&#39;s no target or no recipient, don&#39;t bother
            if (!element.HasAttribute(&quot;target&quot;) || recipient == null)
            {
                return string.Empty;
            }

            // Build a command
            var name = GetAttributeSafe(element, &quot;command&quot;);
            if (name.IsEmpty())
            {
                name = &quot;nav&quot;;
            }
            var target = GetAttributeSafe(element, &quot;target&quot;);
            var data = GetAttributeSafe(element, &quot;data&quot;);

            var command = new ShellCommand(name, target, data);

            // Send the command on to the owner
            var redirect = recipient.ProcessShellCommand(command);

            // If no redirect was specified, use empty
            if (!redirect.HasText())
            {
                return string.Empty;
            }

            // Execute a redirect to the result of the star operation
            try
            {
                var node = BuildNode(string.Format(Locale, &quot;&lt;srai&gt;{0}&lt;/srai&gt;&quot;, redirect).NonNull());
                var parameters = GetTagHandlerParametersForNode(node);
                return new RedirectTagHandler(parameters).Transform();
            }
            catch (XmlException xmlEx)
            {
                Log(string.Format(Locale, &quot;Could not redirect to output due to bad XML: &quot; + redirect, xmlEx.Message), LogLevel.Error);
                return string.Empty;
            }

        }
    }

    /// &lt;summary&gt;
    ///     A tag handler that handles the custom &quot;alfred&quot; tag that integrates Alfred into the AIML system
    ///     and allows AIML files to issue commands to Alfred modules.
    /// &lt;/summary&gt;
    [HandlesAimlTag(&quot;alfred&quot;)]
    public class AlfredTagHandler : AimlTagHandler
    {
        /// &lt;summary&gt;
        ///     Initializes a new instance of the &lt;see cref=&quot;AlfredTagHandler&quot; /&gt; class.
        /// &lt;/summary&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;&lt;paramref name=&quot;parameters&quot; /&gt; is &lt;see langword=&quot;null&quot; /&gt;.&lt;/exception&gt;
        public AlfredTagHandler([NotNull] TagHandlerParameters parameters) : base(parameters)
        {
        }

        /// &lt;summary&gt;
        ///     Processes the input text and returns the processed value.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;The processed output&lt;/returns&gt;
        protected override string ProcessChange()
        {
            var result = new AlfredCommandResult();

            var element = TemplateElement;
            var recipient = ChatEngine.Owner as IAlfredCommandRecipient;

            if (element.HasAttribute(&quot;command&quot;) &amp;&amp; recipient != null)
            {
                // Build a command
                var name = GetAttributeSafe(element, &quot;command&quot;);
                var subsystem = GetAttributeSafe(element, &quot;subsystem&quot;);
                var data = GetAttributeSafe(element, &quot;data&quot;);

                var command = new ChatCommand(subsystem, name, data);

                // Send the command on to the owner. This may modify result or carry out other actions.
                recipient.ProcessAlfredCommand(command, result);
            }

            // Get the output value from the result in case it was set externally
            return result.Output;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[50,13,50,14,0],[51,17,51,37,0],[57,13,57,14,0],[58,17,58,30,0],[59,13,59,14,0],[70,13,70,14,0],[71,17,71,37,0],[81,13,81,39,0],[82,13,82,14,0],[83,17,83,135,0],[84,17,84,37,0],[35,77,35,93,1],[36,9,36,10,1],[37,9,37,10,1],[44,9,44,10,1],[45,13,45,43,1],[46,13,46,72,1],[49,13,49,70,1],[55,13,55,61,1],[56,13,56,32,1],[60,13,60,62,1],[61,13,61,58,1],[63,13,63,64,1],[66,13,66,67,1],[69,13,69,37,1],[76,13,76,14,1],[77,17,77,101,1],[78,17,78,71,1],[79,17,79,71,1],[87,9,87,10,1],[101,78,101,94,1],[102,9,102,10,1],[103,9,103,10,1],[110,9,110,10,1],[111,13,111,52,1],[113,13,113,43,1],[114,13,114,73,1],[116,13,116,70,1],[117,13,117,14,1],[119,17,119,65,1],[120,17,120,72,1],[121,17,121,62,1],[123,17,123,70,1],[126,17,126,65,1],[127,13,127,14,1],[130,13,130,34,1],[131,9,131,10,1]]);
    </script>
  </body>
</html>