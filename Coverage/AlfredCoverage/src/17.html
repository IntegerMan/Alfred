<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\alfred\alfred\matteland.ani.alfred.core.tests\chat\chattestsbase.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// ---------------------------------------------------------
// ChatTestsBase.cs
// 
// Created on:      08/17/2015 at 9:57 PM
// Last Modified:   08/17/2015 at 10:02 PM
// 
// Last Modified by: Matt Eland
// ---------------------------------------------------------

using System.Diagnostics;
using System.Diagnostics.CodeAnalysis;
using System.Xml;

using JetBrains.Annotations;

using MattEland.Ani.Alfred.Chat;
using MattEland.Ani.Alfred.Chat.Aiml;
using MattEland.Ani.Alfred.Chat.Aiml.Utils;
using MattEland.Ani.Alfred.Core;
using MattEland.Ani.Alfred.Core.Definitions;
using MattEland.Ani.Alfred.Core.Modules;

using NUnit.Framework;

namespace MattEland.Ani.Alfred.Tests.Chat
{

    /// &lt;summary&gt;
    /// An abstract class providing testing capabilities related to chats and commanding
    /// &lt;/summary&gt;
    [SuppressMessage(&quot;ReSharper&quot;, &quot;NotNullMemberIsNotInitialized&quot;)]
    [SuppressMessage(&quot;ReSharper&quot;, &quot;ExceptionNotDocumented&quot;)]
    public class ChatTestsBase
    {
        private IChatProvider _chat;

        [NotNull]
        private IAlfred _alfred;
        private AlfredChatSubsystem _chatSubsystem;
        private AlfredCoreSubsystem _coreSubsystem;

        [NotNull]
        private User _user;

        [NotNull]
        public User User
        {
            [DebuggerStepThrough]
            get
            { return _user; }
        }

        public AlfredCoreSubsystem CoreSubsystem
        {
            [DebuggerStepThrough]
            get
            { return _coreSubsystem; }
        }

        public AlfredChatSubsystem ChatSubsystem
        {
            [DebuggerStepThrough]
            get
            { return _chatSubsystem; }
        }

        /// &lt;summary&gt;
        /// Gets or sets the chat engine.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The chat engine.&lt;/value&gt;
        [NotNull]
        protected ChatEngine Engine { get; set; }

        /// &lt;summary&gt;
        /// Gets the chat provider.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The chat provider.&lt;/value&gt;
        public IChatProvider Chat
        {
            [DebuggerStepThrough]
            get
            { return _chat; }
        }

        /// &lt;summary&gt;
        ///     Asserts that the chat input gets a reply template with the specified ID.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;input&quot;&gt;The input.&lt;/param&gt;
        /// &lt;param name=&quot;templateId&quot;&gt;The template identifier.&lt;/param&gt;
        protected void AssertMessageGetsReplyTemplate(string input, string templateId)
        {
            var template = GetReplyTemplate(input);

            AssertTemplateId(template, templateId);
        }

        /// &lt;summary&gt;
        ///     Asserts that the template identifier is found in the response template.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;template&quot;&gt;The template.&lt;/param&gt;
        /// &lt;param name=&quot;id&quot;&gt;The template identifier.&lt;/param&gt;
        private static void AssertTemplateId([NotNull] string template, [NotNull] string id)
        {
            var idString = $&quot;id=\&quot;{id.ToLowerInvariant()}\&quot;&quot;;

            Assert.IsTrue(template.ToLowerInvariant().Contains(idString),
                          $&quot;ID &#39;{idString}&#39; was not found. Template was: {template}&quot;);
        }

        /// &lt;summary&gt;
        ///     Gets a reply from the chat system on a specified inquiry.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;text&quot;&gt;The inquiry text.&lt;/param&gt;
        /// &lt;returns&gt;The reply&lt;/returns&gt;
        [NotNull]
        protected string GetReply([NotNull] string text)
        {
            var response = GetResponse(text);

            Assert.IsNotNull(response.ResponseText, &quot;Response text was null&quot;);

            return response.ResponseText;
        }

        /// &lt;summary&gt;
        /// Says the specified message to Alfred.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;message&quot;&gt;The message.&lt;/param&gt;
        protected void Say([NotNull] string message)
        {
            GetResponse(message);
        }

        /// &lt;summary&gt;
        ///     Gets the response to the chat message.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;text&quot;&gt;The text.&lt;/param&gt;
        /// &lt;returns&gt;The response&lt;/returns&gt;
        private UserStatementResponse GetResponse([NotNull] string text)
        {

            var chatProvider = _alfred.ChatProvider;
            Assert.NotNull(chatProvider, &quot;Alfred&#39;s chat provider was null when instructed to handle chat message&quot;);

            var response = chatProvider.HandleUserStatement(text);

            // Do some basic validity checks
            Assert.NotNull(response, &quot;Response was null&quot;);
            Assert.AreEqual(text, response.UserInput);
            return response;
        }

        /// &lt;summary&gt;
        ///     Gets a reply from the chat system on a specified inquiry.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;text&quot;&gt;The inquiry text.&lt;/param&gt;
        /// &lt;returns&gt;The reply&lt;/returns&gt;
        [CanBeNull]
        protected string GetReplyTemplate([CanBeNull] string text)
        {
            var response = GetResponse(text);

            Assert.IsNotNull(response, &quot;Alfred&#39;s response was null&quot;);
            return response.Template;
        }

        /// &lt;summary&gt;
        ///     Initializes the chat system.
        /// &lt;/summary&gt;
        protected void InitChatSystem()
        {
            var bootstrapper = new AlfredBootstrapper();
            _alfred = bootstrapper.Create();

            // Add Subsystems to alfred

            _coreSubsystem = new AlfredCoreSubsystem(_alfred.PlatformProvider);
            _alfred.Register(_coreSubsystem);

            _chatSubsystem = new AlfredChatSubsystem(_alfred.PlatformProvider, _alfred.Console);
            _alfred.Register(_chatSubsystem);

            // Do some extra registration work with the chat engine as we want its components for testing
            var chatHandler = _chatSubsystem.ChatHandler;
            _chat = chatHandler;
            Assert.IsNotNull(chatHandler.ChatEngine, &quot;Chat Engine was null&quot;);
            Engine = chatHandler.ChatEngine;
            _user = new User(&quot;Test User&quot;, Engine);

            // Start Alfred - doesn&#39;t make sense to have a chat test that doesn&#39;t need Alfred online first.
            _alfred.Initialize();
            _alfred.Update();
        }

        /// &lt;summary&gt;
        /// Gets the alfred framework.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The alfred framework.&lt;/value&gt;
        [NotNull]
        protected IAlfred Alfred
        {
            get { return _alfred; }
        }

        [NotNull]
        protected TagHandlerParameters BuildTagHandlerParameters(string xml)
        {
            var node = AimlTagHandler.BuildNode(xml);
            return BuildTagHandlerParameters(&quot;Testing is fun&quot;, node);
        }

        [NotNull]
        private TagHandlerParameters BuildTagHandlerParameters(string input, XmlNode node)
        {
            var query = new SubQuery(input);
            var request = new Request(input, User, Engine);
            var result = new Result(User, Engine, request);
            return new TagHandlerParameters(Engine, User, query, request, result, node);
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[57,13,57,14,0],[57,15,57,37,0],[57,38,57,39,0],[64,13,64,14,0],[64,15,64,37,0],[64,38,64,39,0],[82,13,82,14,0],[82,15,82,28,0],[82,29,82,30,0],[130,9,130,10,0],[131,13,131,34,0],[132,9,132,10,0],[202,17,202,18,0],[202,19,202,34,0],[202,35,202,36,0],[50,13,50,14,1],[50,15,50,28,1],[50,29,50,30,1],[72,39,72,43,1],[72,44,72,48,1],[91,9,91,10,1],[92,13,92,52,1],[94,13,94,52,1],[95,9,95,10,1],[103,9,103,10,1],[104,13,104,62,1],[106,13,107,87,1],[108,9,108,10,1],[117,9,117,10,1],[118,13,118,46,1],[120,13,120,79,1],[122,13,122,42,1],[123,9,123,10,1],[140,9,140,10,1],[142,13,142,53,1],[143,13,143,116,1],[145,13,145,67,1],[148,13,148,59,1],[149,13,149,55,1],[150,13,150,29,1],[151,9,151,10,1],[160,9,160,10,1],[161,13,161,46,1],[163,13,163,70,1],[164,13,164,38,1],[165,9,165,10,1],[171,9,171,10,1],[172,13,172,57,1],[173,13,173,45,1],[177,13,177,80,1],[178,13,178,46,1],[180,13,180,97,1],[181,13,181,46,1],[184,13,184,58,1],[185,13,185,33,1],[186,13,186,78,1],[187,13,187,45,1],[188,13,188,51,1],[191,13,191,34,1],[192,13,192,30,1],[193,9,193,10,1],[207,9,207,10,1],[208,13,208,54,1],[209,13,209,70,1],[210,9,210,10,1],[214,9,214,10,1],[215,13,215,45,1],[216,13,216,60,1],[217,13,217,60,1],[218,13,218,89,1],[219,9,219,10,1]]);
    </script>
  </body>
</html>