<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\alfred\alfred\matteland.ani.alfred.core\delegatingchatprovider.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// ---------------------------------------------------------
// DelegatingChatProvider.cs
// 
// Created on:      08/11/2015 at 10:41 PM
// Last Modified:   08/11/2015 at 11:08 PM
// Original author: Matt Eland
// ---------------------------------------------------------

using System;
using System.ComponentModel;
using System.Diagnostics;
using System.Linq;

using JetBrains.Annotations;

using MattEland.Ani.Alfred.Core.Definitions;

namespace MattEland.Ani.Alfred.Core
{
    /// &lt;summary&gt;
    ///     A chat provider that intercepts responses before they get to the user and optionally executes/routes commands on
    ///     behalf of Alfred. This lets us decorate an existing IChatProvider and route responses both to submodules and to the
    ///     user.
    /// &lt;/summary&gt;
    /// &lt;remarks&gt;
    ///     This supports INotifyPropertyChanged to enable data binding
    /// &lt;/remarks&gt;
    internal sealed class DelegatingChatProvider : IChatProvider, INotifyPropertyChanged
    {
        [NotNull]
        private readonly IAlfred _alfred;

        [NotNull]
        private readonly IChatProvider _chatProvider;

        [CanBeNull]
        private string _lastInput;

        private UserStatementResponse _lastResponse;

        /// &lt;summary&gt;
        ///     Initializes a new instance of the &lt;see cref=&quot;DelegatingChatProvider&quot; /&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;chatProvider&quot;&gt;The chat provider.&lt;/param&gt;
        /// &lt;param name=&quot;alfred&quot;&gt;The alfred instance.&lt;/param&gt;
        public DelegatingChatProvider([NotNull] IChatProvider chatProvider, [NotNull] IAlfred alfred)
        {
            //- Validate for Sanity
            if (chatProvider == null)
            {
                throw new ArgumentNullException(nameof(chatProvider));
            }
            if (alfred == null)
            {
                throw new ArgumentNullException(nameof(alfred));
            }

            //- Store our references
            _chatProvider = chatProvider;
            _alfred = alfred;

            // Take delegated values as the last values from the chat provider
            _lastInput = chatProvider.LastInput;
            _lastResponse = chatProvider.LastResponse;
        }

        /// &lt;summary&gt;
        ///     Gets the chat provider.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The chat provider.&lt;/value&gt;
        [NotNull]
        public IChatProvider ChatProvider
        {
            [DebuggerStepThrough]
            get
            { return _chatProvider; }
        }

        /// &lt;summary&gt;
        ///     Gets the alfred instance.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The alfred instance.&lt;/value&gt;
        [NotNull]
        public IAlfred Alfred
        {
            [DebuggerStepThrough]
            get
            { return _alfred; }
        }

        /// &lt;summary&gt;
        ///     Handles a user statement.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;userInput&quot;&gt;The user input.&lt;/param&gt;
        /// &lt;returns&gt;The response to the user statement&lt;/returns&gt;
        public UserStatementResponse HandleUserStatement(string userInput)
        {
            //+ Delegate the actual work of processing the input to a chat provider
            var response = ChatProvider.HandleUserStatement(userInput);

            //+ Route this to Alfred&#39;s Subsystems to handle as a command
            var result = CommandDispatcher.HandleChatCommand(response, Alfred);

            if (!string.IsNullOrWhiteSpace(result.RedirectToChat))
            {
                //! Do a recursive call to HandleUserInput with the new redirect
                response = HandleUserStatement(result.RedirectToChat);
            }
            else
            {
                // We&#39;ll stick our new values into the response as well so the command can change things
                response = new UserStatementResponse(result.NewLastInput,
                                                     result.NewLastOutput,
                                                     response.Template,
                                                     response.Command);
            }

            //- Update and return our values so the consumer can check or bind to this instance.
            LastInput = response.UserInput;
            LastResponse = response;

            return response;
        }

        /// &lt;summary&gt;
        ///     Gets the last response from the system.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The last response.&lt;/value&gt;
        public UserStatementResponse LastResponse
        {
            get { return _lastResponse; }
            set
            {
                if (value.Equals(_lastResponse))
                {
                    return;
                }
                _lastResponse = value;
                OnPropertyChanged(nameof(LastResponse));
            }
        }

        /// &lt;summary&gt;
        ///     Gets the last input from the user.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The last input.&lt;/value&gt;
        public string LastInput
        {
            get { return _lastInput; }
            private set
            {
                if (value == _lastInput)
                {
                    return;
                }
                _lastInput = value;
                OnPropertyChanged(nameof(LastInput));
            }
        }

        /// &lt;summary&gt;
        /// Does an initial greeting to the user without requiring any input. This should set LastInput to null.
        /// &lt;/summary&gt;
        public void DoInitialGreeting()
        {
            // Send an event to the chat system as if the user typed it. The data files will
            // handle it from there as far as generating proper content.
            const string StartupTopic = &quot;EVT_STARTUP&quot;;
            HandleUserStatement(StartupTopic);

            // Clear out any evidence of simulating the user talking to the chat system
            LastInput = null;
        }

        /// &lt;summary&gt;
        ///     Occurs when a property changes.
        /// &lt;/summary&gt;
        public event PropertyChangedEventHandler PropertyChanged;

        /// &lt;summary&gt;
        ///     Called when a property changes and raises the property changed event
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;propertyName&quot;&gt;Name of the property.&lt;/param&gt;
        [NotifyPropertyChangedInvocator]
        private void OnPropertyChanged(string propertyName)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }

}
    </pre>
    <script type="text/javascript">
      highlightRanges([[46,9,46,102,0],[47,9,47,10,0],[49,13,49,38,0],[50,13,50,14,0],[51,17,51,71,0],[53,13,53,32,0],[54,13,54,14,0],[55,17,55,65,0],[59,13,59,42,0],[60,13,60,30,0],[63,13,63,49,0],[64,13,64,55,0],[65,9,65,10,0],[76,13,76,14,0],[76,15,76,36,0],[76,37,76,38,0],[88,13,88,14,0],[88,15,88,30,0],[88,31,88,32,0],[97,9,97,10,0],[99,13,99,72,0],[102,13,102,80,0],[104,13,104,67,0],[105,13,105,14,0],[107,17,107,71,0],[108,13,108,14,0],[110,13,110,14,0],[112,17,115,72,0],[116,13,116,14,0],[119,13,119,44,0],[120,13,120,37,0],[122,13,122,29,0],[123,9,123,10,0],[131,17,131,18,0],[131,19,131,40,0],[131,41,131,42,0],[133,13,133,14,0],[134,17,134,49,0],[135,17,135,18,0],[136,21,136,28,0],[138,17,138,39,0],[139,17,139,57,0],[140,13,140,14,0],[149,17,149,18,0],[149,19,149,37,0],[149,38,149,39,0],[151,13,151,14,0],[152,17,152,41,0],[153,17,153,18,0],[154,21,154,28,0],[156,17,156,36,0],[157,17,157,54,0],[158,13,158,14,0],[165,9,165,10,0],[169,13,169,47,0],[172,13,172,30,0],[173,9,173,10,0],[186,9,186,10,0],[187,13,187,87,0],[188,9,188,10,0]]);
    </script>
  </body>
</html>