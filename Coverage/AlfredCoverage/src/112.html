<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\alfred\matteland.ani.alfred.aiml\alfredcommandrouter.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// ---------------------------------------------------------
// AlfredCommandRouter.cs
// 
// Created on:      08/19/2015 at 9:31 PM
// Last Modified:   08/21/2015 at 5:46 PM
// 
// Last Modified by: Matt Eland
// ---------------------------------------------------------

using System.Globalization;

using JetBrains.Annotations;

using MattEland.Ani.Alfred.Core;
using MattEland.Ani.Alfred.Core.Console;
using MattEland.Ani.Alfred.Core.Definitions;
using MattEland.Common;

namespace MattEland.Ani.Alfred.Chat
{
    /// &lt;summary&gt;
    ///     This class takes commands in and handles them by routing them to various components in an
    ///     Alfred application.
    /// &lt;/summary&gt;
    public class AlfredCommandRouter : IAlfredCommandRecipient, IShellCommandRecipient
    {
        /// &lt;summary&gt;
        ///     Gets or sets the alfred instance.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The alfred instance.&lt;/value&gt;
        [CanBeNull]
        public IAlfred Alfred { get; set; }

        /// &lt;summary&gt;
        ///     Processes an Alfred Command. If the command is handled, result should be modified accordingly
        ///     and the method should return true. Returning false will not stop the message from being
        ///     propagated.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command.&lt;/param&gt;
        /// &lt;param name=&quot;result&quot;&gt;The result. If the command was handled, this should be updated.&lt;/param&gt;
        /// &lt;returns&gt;&lt;c&gt;True&lt;/c&gt; if the command was handled; otherwise false.&lt;/returns&gt;
        public bool ProcessAlfredCommand(ChatCommand command, AlfredCommandResult result)
        {
            var alfred = Alfred;
            if (alfred == null)
            {
                return false;
            }

            // Extract our target for loop readability
            var target = command.Subsystem;

            // Commands are very, very important and need to be logged.
            alfred.Console?.Log(&quot;CommandRouting&quot;,
                                string.Format(CultureInfo.CurrentCulture,
                                              &quot;Command &#39;{0}&#39; raised for subsystem &#39;{1}&#39; with data value of &#39;{2}&#39;.&quot;,
                                              command.Name,
                                              target,
                                              command.Data),
                                LogLevel.Info);

            // Send the command to each subsystem. These will in turn send it on to their pages and modules.
            foreach (var subsystem in alfred.Subsystems)
            {
                // If the command isn&#39;t for the subsystem, move on.
                if (target.HasText() &amp;&amp; !target.Matches(subsystem.Id))
                {
                    continue;
                }

                // Send the command to the subsystem for routing. If it&#39;s handled, the subsystem will return true.
                if (subsystem.ProcessAlfredCommand(command, result))
                {
                    return true;
                }
            }

            return false;
        }

        /// &lt;summary&gt;
        ///     Processes a shell command by sending it on to the user interface layer.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;command&quot;&gt;The command.&lt;/param&gt;
        [NotNull]
        public string ProcessShellCommand(ShellCommand command)
        {
            // Commands are very, very important and need to be logged.
            Alfred?.Console?.Log(&quot;CommandRouting&quot;,
                                 string.Format(
                                               &quot;Shell Command &#39;{0}&#39; raised targeting &#39;{1}&#39; with data value of &#39;{2}&#39;.&quot;,
                                               command.Name,
                                               command.Target,
                                               command.Data),
                                 LogLevel.Info);

            var shell = Alfred?.ShellCommandHandler;

            var result = shell?.ProcessShellCommand(command);

            return result.NonNull();
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[46,13,46,14,0],[47,17,47,30,0],[32,33,32,37,1],[32,38,32,42,1],[43,9,43,10,1],[44,13,44,33,1],[45,13,45,32,1],[51,13,51,44,1],[54,13,60,48,1],[63,13,63,20,1],[63,39,63,56,1],[63,22,63,35,1],[64,13,64,14,1],[66,17,66,71,1],[67,17,67,18,1],[68,21,68,30,1],[72,17,72,69,1],[73,17,73,18,1],[74,21,74,33,1],[76,13,76,14,1],[63,36,63,38,1],[78,13,78,26,1],[79,9,79,10,1],[87,9,87,10,1],[89,13,95,49,1],[97,13,97,53,1],[99,13,99,62,1],[101,13,101,37,1],[102,9,102,10,1]]);
    </script>
  </body>
</html>