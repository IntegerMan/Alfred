<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\alfred\matteland.ani.alfred.core\alfredapplication.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// ---------------------------------------------------------
// AlfredApplication.cs
// 
// Created on:      07/25/2015 at 11:30 PM
// Last Modified:   08/11/2015 at 7:02 PM
// Original author: Matt Eland
// ---------------------------------------------------------

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Diagnostics;
using System.Diagnostics.CodeAnalysis;
using System.Globalization;
using System.Linq;

using JetBrains.Annotations;

using MattEland.Ani.Alfred.Core.Console;
using MattEland.Ani.Alfred.Core.Definitions;
using MattEland.Common;

namespace MattEland.Ani.Alfred.Core
{
    /// &lt;summary&gt;
    ///     Coordinates providing personal assistance to a user interface and receiving settings and queries back from the user
    ///     interface.
    /// &lt;/summary&gt;
    public sealed class AlfredApplication : INotifyPropertyChanged, IAlfred
    {
        /// &lt;summary&gt;
        ///     The platform provider
        /// &lt;/summary&gt;
        [NotNull]
        private readonly IPlatformProvider _platformProvider;

        /// &lt;summary&gt;
        ///     The status controller
        /// &lt;/summary&gt;
        [NotNull]
        private readonly IStatusController _statusController;

        [NotNull]
        private readonly ICollection&lt;IAlfredSubsystem&gt; _subsystems;

        [CanBeNull]
        private IChatProvider _chatProvider;

        /// &lt;summary&gt;
        ///     The status
        /// &lt;/summary&gt;
        private AlfredStatus _status;

        [CanBeNull]
        private IShellCommandRecipient _shellCommandHandler;

        /// &lt;summary&gt;
        ///     Initializes a new instance of the &lt;see cref=&quot;AlfredApplication&quot; /&gt; class.
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;
        ///     Initialization should come from AlfredBootstrapper
        /// &lt;/remarks&gt;
        /// &lt;param name=&quot;provider&quot;&gt;The provider.&lt;/param&gt;
        /// &lt;param name=&quot;controller&quot;&gt;The controller.&lt;/param&gt;
        /// &lt;exception cref=&quot;System.ArgumentNullException&quot;&gt;provider&lt;/exception&gt;
        internal AlfredApplication([NotNull] IPlatformProvider provider, [CanBeNull] IStatusController controller)
        {
            // Set the controller
            if (controller == null)
            {
                controller = new AlfredStatusController(this);
            }
            _statusController = controller;
            _statusController.Alfred = this;

            // Set the provider
            if (provider == null)
            {
                throw new ArgumentNullException(nameof(provider));
            }
            _platformProvider = provider;

            // Build out sub-collections
            _subsystems = provider.CreateCollection&lt;IAlfredSubsystem&gt;();
        }

        /// &lt;summary&gt;
        ///     Gets the chat provider.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The chat provider.&lt;/value&gt;
        [CanBeNull]
        public IChatProvider ChatProvider
        {
            [DebuggerStepThrough]
            get
            { return _chatProvider; }
            private set
            {
                if (Equals(value, _chatProvider))
                {
                    return;
                }

                _chatProvider = value;
                OnPropertyChanged(nameof(ChatProvider));
            }
        }

        /// &lt;summary&gt;
        ///     Gets the name and version of Alfred.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The name and version.&lt;/value&gt;
        [NotNull]
        public string NameAndVersion
        {
            get { return string.Format(CultureInfo.CurrentCulture, &quot;{0} {1}&quot;, Name, Version); }
        }

        /// &lt;summary&gt;
        ///     Gets the name of the framework.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The name.&lt;/value&gt;
        [NotNull]
        public string Version
        {
            get
            {
                // We&#39;ll base this off of the AssemblyVersion.
                var version = this.GetAssemblyVersion();
                return version?.ToString() ?? string.Empty;
            }
        }

        /// &lt;summary&gt;
        ///     Gets the collection provider used for cross platform portability.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The collection provider.&lt;/value&gt;
        [NotNull]
        public IPlatformProvider PlatformProvider
        {
            get { return _platformProvider; }
        }

        /// &lt;summary&gt;
        /// Gets the shell command handler that can pass shell commands on to the user interface.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The shell command handler.&lt;/value&gt;
        public IShellCommandRecipient ShellCommandHandler
        {
            get { return _shellCommandHandler; }
        }

        /// &lt;summary&gt;
        ///     Gets or sets the console provider. This can be null.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The console.&lt;/value&gt;
        [CanBeNull]
        public IConsole Console { get; set; }

        /// &lt;summary&gt;
        ///     Gets the name of the framework.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The name.&lt;/value&gt;
        [NotNull]
        public string Name
        {
            get { return Resources.AlfredProvider_Name.NonNull(); }
        }

        /// &lt;summary&gt;
        ///     Gets the status.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The status.&lt;/value&gt;
        public AlfredStatus Status
        {
            get { return _status; }
            set
            {
                if (value != _status)
                {
                    _status = value;
                    OnPropertyChanged(nameof(Status));
                    OnPropertyChanged(nameof(IsOnline));
                }
            }
        }

        /// &lt;summary&gt;
        ///     Gets the sub systems associated wih Alfred.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The sub systems.&lt;/value&gt;
        [NotNull]
        [ItemNotNull]
        public IEnumerable&lt;IAlfredSubsystem&gt; Subsystems
        {
            get { return _subsystems; }
        }

        /// &lt;summary&gt;
        ///     Gets the user interface pages registered to the Alfred Framework at root level.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The pages.&lt;/value&gt;
        [NotNull]
        [ItemNotNull]
        [SuppressMessage(&quot;ReSharper&quot;, &quot;AssignNullToNotNullAttribute&quot;)]
        public IEnumerable&lt;IAlfredPage&gt; RootPages
        {
            get
            {
                // Give me all pages in subsystems that are root level pages
                return Subsystems.SelectMany(subSystem =&gt; subSystem.RootPages);
            }
        }

        /// &lt;summary&gt;
        ///     Gets Whether or not Alfred is online.
        /// &lt;/summary&gt;
        /// &lt;value&gt;The is online.&lt;/value&gt;
        public bool IsOnline
        {
            get { return Status == AlfredStatus.Online; }
        }

        /// &lt;summary&gt;
        ///     Tells Alfred it&#39;s okay to start itself up and begin operating.
        /// &lt;/summary&gt;
        /// &lt;exception cref=&quot;InvalidOperationException&quot;&gt;
        ///     Thrown if Alfred is already Online
        /// &lt;/exception&gt;
        public void Initialize()
        {
            // This logic is a bit lengthy, so we&#39;ll have the status controller take care of it
            _statusController.Initialize();
        }

        /// &lt;summary&gt;
        ///     Tells Alfred to go ahead and shut down.
        /// &lt;/summary&gt;
        /// &lt;exception cref=&quot;InvalidOperationException&quot;&gt;
        ///     Thrown if Alfred is already Offline
        /// &lt;/exception&gt;
        public void Shutdown()
        {
            // This process is a little lengthy so we&#39;ll have the status controller handle it
            _statusController.Shutdown();
        }

        /// &lt;summary&gt;
        /// Registers the shell command recipient that will allow the shell to get commands from the Alfred layer.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;shell&quot;&gt;The command recipient.&lt;/param&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;&lt;paramref name=&quot;shell&quot;/&gt; is &lt;see langword=&quot;null&quot; /&gt;.&lt;/exception&gt;
        public void Register(IShellCommandRecipient shell)
        {
            if (shell == null)
            {
                throw new ArgumentNullException(nameof(shell));
            }
            _shellCommandHandler = shell;
        }

        /// &lt;summary&gt;
        ///     Registers the chat provider as the framework&#39;s chat provider.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;chatProvider&quot;&gt;The chat provider.&lt;/param&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;&lt;paramref name=&quot;chatProvider&quot;/&gt; is &lt;see langword=&quot;null&quot; /&gt;.&lt;/exception&gt;
        public void Register([NotNull] IChatProvider chatProvider)
        {
            if (chatProvider == null)
            {
                throw new ArgumentNullException(nameof(chatProvider));
            }

            ChatProvider = chatProvider;
        }

        /// &lt;summary&gt;
        ///     Occurs when a property changes.
        /// &lt;/summary&gt;
        public event PropertyChangedEventHandler PropertyChanged;

        /// &lt;summary&gt;
        ///     Tells modules to take a look at their content and update as needed.
        /// &lt;/summary&gt;
        /// &lt;exception cref=&quot;InvalidOperationException&quot;&gt;
        ///     Thrown if Alfred is not Online
        /// &lt;/exception&gt;
        public void Update()
        {
            // Error check
            if (Status != AlfredStatus.Online)
            {
                throw new InvalidOperationException(Resources.AlfredProvider_Update_ErrorMustBeOnline);
            }

            // Update every system
            foreach (var item in Subsystems)
            {
                item.Update();
            }
        }

        /// &lt;summary&gt;
        ///     Registers a sub system with Alfred.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;subsystem&quot;&gt;The subsystem.&lt;/param&gt;
        /// &lt;exception cref=&quot;InvalidOperationException&quot;&gt;If a subsystem was registered when Alfred was offline.&lt;/exception&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;&lt;paramref name=&quot;subsystem&quot;/&gt; is &lt;see langword=&quot;null&quot; /&gt;.&lt;/exception&gt;
        public void Register([NotNull] AlfredSubsystem subsystem)
        {
            if (subsystem == null)
            {
                throw new ArgumentNullException(nameof(subsystem));
            }
            if (Status != AlfredStatus.Offline)
            {
                throw new InvalidOperationException(Resources.AlfredProvider_AssertMustBeOffline_ErrorNotOffline);
            }

            _subsystems.AddSafe(subsystem);
            subsystem.OnRegistered(this);
        }

        /// &lt;summary&gt;
        ///     Called when a property changes.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;propertyName&quot;&gt;Name of the property.&lt;/param&gt;
        [NotifyPropertyChangedInvocator]
        private void OnPropertyChanged([CanBeNull] string propertyName)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }
    }

}
    </pre>
    <script type="text/javascript">
      highlightRanges([[70,13,70,14,0],[71,17,71,63,0],[72,13,72,14,0],[78,13,78,14,0],[79,17,79,67,0],[96,13,96,14,0],[96,15,96,36,0],[96,37,96,38,0],[98,13,98,14,0],[99,17,99,50,0],[100,17,100,18,0],[101,21,101,28,0],[104,17,104,39,0],[105,17,105,57,0],[106,13,106,14,0],[116,17,116,18,0],[116,19,116,94,0],[116,95,116,96,0],[127,13,127,14,0],[129,17,129,57,0],[130,17,130,60,0],[131,13,131,14,0],[150,17,150,18,0],[150,19,150,47,0],[150,48,150,49,0],[221,17,221,18,0],[221,19,221,56,0],[221,57,221,58,0],[254,9,254,10,0],[255,13,255,31,0],[256,13,256,14,0],[257,17,257,64,0],[259,13,259,42,0],[260,9,260,10,0],[268,9,268,10,0],[269,13,269,38,0],[270,13,270,14,0],[271,17,271,71,0],[274,13,274,41,0],[275,9,275,10,0],[66,9,66,115,1],[67,9,67,10,1],[69,13,69,36,1],[73,13,73,44,1],[74,13,74,45,1],[77,13,77,34,1],[81,13,81,42,1],[84,13,84,73,1],[85,9,85,10,1],[141,17,141,18,1],[141,19,141,44,1],[141,45,141,46,1],[158,35,158,39,1],[158,40,158,44,1],[167,17,167,18,1],[167,19,167,66,1],[167,67,167,68,1],[176,17,176,18,1],[176,19,176,34,1],[176,35,176,36,1],[178,13,178,14,1],[179,17,179,38,1],[180,17,180,18,1],[181,21,181,37,1],[182,21,182,55,1],[183,21,183,57,1],[184,17,184,18,1],[185,13,185,14,1],[196,17,196,18,1],[196,19,196,38,1],[196,39,196,40,1],[209,13,209,14,1],[211,17,211,59,1],[211,78,211,80,1],[212,13,212,14,1],[231,9,231,10,1],[233,13,233,44,1],[234,9,234,10,1],[243,9,243,10,1],[245,13,245,42,1],[246,9,246,10,1],[289,9,289,10,1],[291,13,291,47,1],[292,13,292,14,1],[293,17,293,104,1],[297,13,297,20,1],[297,34,297,44,1],[297,22,297,30,1],[298,13,298,14,1],[299,17,299,31,1],[300,13,300,14,1],[297,31,297,33,1],[301,9,301,10,1],[310,9,310,10,1],[311,13,311,35,1],[312,13,312,14,1],[313,17,313,68,1],[315,13,315,48,1],[316,13,316,14,1],[317,17,317,115,1],[320,13,320,44,1],[321,13,321,42,1],[322,9,322,10,1],[330,9,330,10,1],[331,13,331,87,1],[332,9,332,10,1],[211,59,211,78,1]]);
    </script>
  </body>
</html>