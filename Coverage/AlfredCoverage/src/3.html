<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\dev\alfred\matteland.ani.alfred.core.tests\alfredprovidertests.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// ---------------------------------------------------------
// AlfredProviderTests.cs
// 
// Created on:      07/25/2015 at 11:43 PM
// Last Modified:   08/10/2015 at 10:34 PM
// Original author: Matt Eland
// ---------------------------------------------------------

using System;
using System.Diagnostics.CodeAnalysis;
using System.Linq;

using JetBrains.Annotations;

using MattEland.Ani.Alfred.Core;
using MattEland.Ani.Alfred.Core.Console;
using MattEland.Ani.Alfred.Core.Definitions;
using MattEland.Ani.Alfred.Core.Modules;
using MattEland.Ani.Alfred.Core.Pages;
using MattEland.Ani.Alfred.Core.Widgets;
using MattEland.Ani.Alfred.Tests.Mocks;

using NUnit.Framework;

namespace MattEland.Ani.Alfred.Tests
{
    /// &lt;summary&gt;
    ///     Tests AlfredApplication
    /// &lt;/summary&gt;
    [TestFixture]
    [SuppressMessage(&quot;ReSharper&quot;, &quot;NotNullMemberIsNotInitialized&quot;)]
    public sealed class AlfredProviderTests
    {
        /// &lt;summary&gt;
        ///     Sets up the alfred provider&#39;s tests.
        /// &lt;/summary&gt;
        [SetUp]
        public void SetupAlfredProviderTests()
        {
            var bootstrapper = new AlfredBootstrapper();
            _alfred = bootstrapper.Create();
            _alfred.Console = new SimpleConsole();

            _subsystem = new TestSubsystem(_alfred.PlatformProvider);
            _page = new AlfredModuleListPage(_alfred.PlatformProvider, &quot;Test Page&quot;, &quot;Test&quot;);
        }

        [NotNull]
        private AlfredApplication _alfred;

        [NotNull]
        private TestSubsystem _subsystem;

        [NotNull]
        private AlfredModuleListPage _page;

        [Test]
        public void AddingStandardModulesAddsModules()
        {
            _alfred.Register(new AlfredCoreSubsystem(_alfred.PlatformProvider));

            var numModules =
                _alfred.Subsystems.SelectMany(subsystem =&gt; subsystem.Pages)
                       .OfType&lt;AlfredModuleListPage&gt;()
                       .Sum(modulePage =&gt; modulePage.Modules.Count());

            Assert.Greater(numModules,
                           0,
                           &quot;Alfred did not have any modules after calling add standard modules.&quot;);
        }

        [Test]
        public void AfterInitializationAlfredIsOnline()
        {
            _alfred.Initialize();

            Assert.AreEqual(_alfred.Status, AlfredStatus.Online);
        }

        [Test]
        public void AlfredStartsOffline()
        {
            Assert.AreEqual(_alfred.Status, AlfredStatus.Offline);
        }

        [Test]
        public void AlfredStartsWithNoSubSystems()
        {
            Assert.AreEqual(0, _alfred.Subsystems.Count(), &quot;Alfred started with subsystems when none were expected.&quot;);
        }

        [Test]
        public void InitializationWithoutConsoleWorks()
        {
            _alfred.Console = null;

            _alfred.Initialize();

            // Nothing to assert here - I&#39;m looking for errors encountered
        }

        /// &lt;summary&gt;
        ///     Tests initialization of Alfred
        /// &lt;/summary&gt;
        [Test]
        public void InitializeAlfred()
        {
            Assert.NotNull(_alfred, &quot;Alfred was not initialized&quot;);
        }

        [Test]
        public void InitializeAndShutdownResultsInShutdown()
        {
            _alfred.Initialize();
            _alfred.Shutdown();

            Assert.AreEqual(_alfred.Status, AlfredStatus.Offline);
        }

        [Test]
        public void InitializeCreatesEventsInLog()
        {
            var console = _alfred.Console;
            Assert.NotNull(console, &quot;Console was not present&quot;);

            var numEvents = console.Events.Count();

            _alfred.Initialize();

            Assert.Greater(console.Events.Count(), numEvents, &quot;Initializing Alfred did not create any log entries.&quot;);
        }

        [Test]
        public void InitializeWhileOnlineErrors()
        {
            _alfred.Initialize();

            try
            {
                _alfred.Initialize();

                Assert.Fail(&quot;Expected an InvalidOperationException since Alfred was already initialized.&quot;);

            }
            catch (InvalidOperationException)
            {
                // No action
            }

            // Assert that we&#39;re still online.
            Assert.AreEqual(_alfred.Status, AlfredStatus.Online);
        }

        [Test]
        public void InitializingInitializesComponents()
        {
            _alfred.Register(new AlfredCoreSubsystem(_alfred.PlatformProvider));

            _alfred.Initialize();

            foreach (var item in _alfred.Subsystems)
            {
                Assert.AreEqual(AlfredStatus.Online,
                                item.Status,
                                $&quot;{item.NameAndVersion} was not initialized during initialization.&quot;);
            }
        }

        [Test]
        public void LogToConsole()
        {
            var console = _alfred.Console;
            Assert.NotNull(console, &quot;Console was not present&quot;);

            var numEvents = console.Events.Count();

            console.Log(&quot;Alfred Test Framework&quot;, &quot;Testing logging to Alfred&quot;, LogLevel.Verbose);

            Assert.AreEqual(numEvents + 1, console.Events.Count(), &quot;Event count did not increase after logging.&quot;);
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ModulesCannotBeAddedWhileOnline()
        {
            _alfred.Initialize();
            _alfred.Register(new AlfredCoreSubsystem(_alfred.PlatformProvider));
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ModulesCannotUpdateWhileOffline()
        {
            _alfred.Register(new AlfredCoreSubsystem(_alfred.PlatformProvider));

            _alfred.Update();
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void RegisteringAWidgetMultipleTimesThrowsAnException()
        {
            var testModule = new AlfredTestModule();

            var textWidget = new TextWidget();
            testModule.WidgetsToRegisterOnInitialize.Add(textWidget);
            testModule.WidgetsToRegisterOnInitialize.Add(textWidget);

            _alfred.Register(_subsystem);
            _subsystem.AddAutoRegisterPage(_page);
            _page.Register(testModule);

            _alfred.Initialize();
        }

        [Test]
        [ExpectedException(typeof(ArgumentNullException))]
        [SuppressMessage(&quot;ReSharper&quot;, &quot;AssignNullToNotNullAttribute&quot;)]
        public void RegisteringNullSubsystemGeneratesNullRef()
        {
            AlfredSubsystem system = null;
            _alfred.Register(system);
        }

        [Test]
        public void RegisteringWidgetAtInitializeAndShutdownLeavesOneCopyInListAtReinitialize()
        {
            var testModule = new AlfredTestModule();

            var textWidget = new TextWidget();
            testModule.WidgetsToRegisterOnInitialize.Add(textWidget);
            testModule.WidgetsToRegisterOnShutdown.Add(textWidget);

            _alfred.Register(_subsystem);
            _subsystem.AddAutoRegisterPage(_page);
            _page.Register(testModule);

            _alfred.Initialize();
            _alfred.Update();
            _alfred.Shutdown();
            _alfred.Initialize();
            _alfred.Update();

            Assert.IsNotNull(testModule.Widgets, &quot;testModule.Widgets was null&quot;);
            Assert.AreEqual(1,
                            testModule.Widgets.Count(),
                            &quot;Widgets were not properly cleared from list after re-initialize&quot;);

        }

        [Test]
        public void RemoveAlfredConsole()
        {
            _alfred.Console = null;

            Assert.IsNull(_alfred.Console, &quot;Could not remove Alfred&#39;s console&quot;);
        }

        [Test]
        public void SetConsole()
        {
            Assert.IsNotNull(_alfred.Console, &quot;Alfred&#39;s console was null after creation&quot;);
        }

        [Test]
        public void ShutdownCreatesEventsInLog()
        {
            // We need to be online to shut down or else we&#39;ll get errors
            _alfred.Initialize();

            var console = _alfred.Console;
            Assert.NotNull(console, &quot;Console was not present&quot;);

            var numEvents = console.Events.Count();

            _alfred.Shutdown();

            Assert.Greater(console.Events.Count(), numEvents, &quot;Shutting Alfred down did not create any log entries.&quot;);
        }

        [Test]
        public void ShutdownWhileOfflineErrors()
        {
            try
            {
                _alfred.Shutdown();

                Assert.Fail(&quot;Expected an InvalidOperationException since Alfred was already offline.&quot;);

            }
            catch (InvalidOperationException)
            {
                // No action
            }

            // Assert that we&#39;re now offline.
            Assert.AreEqual(_alfred.Status, AlfredStatus.Offline);
        }

        [Test]
        public void ShuttingDownShutsDownComponents()
        {
            _alfred.Register(new AlfredCoreSubsystem(_alfred.PlatformProvider));

            _alfred.Initialize();
            _alfred.Shutdown();

            foreach (var item in _alfred.Subsystems)
            {
                Assert.AreEqual(AlfredStatus.Offline,
                                item.Status,
                                $&quot;{item.NameAndVersion} was not shut down during alfred shut down.&quot;);
            }
        }

        [Test]
        [ExpectedException(typeof(InvalidOperationException))]
        public void UpdateWithNoModulesWhileOfflineStillGeneratesError()
        {
            _alfred.Update();
        }
    }

}
    </pre>
    <script type="text/javascript">
      highlightRanges([[142,17,142,108,0],[144,13,144,14,0],[188,9,188,10,0],[197,9,197,10,0],[214,9,214,10,0],[223,9,223,10,0],[288,17,288,104,0],[290,13,290,14,0],[321,9,321,10,0],[39,9,39,10,1],[40,13,40,57,1],[41,13,41,45,1],[42,13,42,51,1],[44,13,44,70,1],[45,13,45,93,1],[46,9,46,10,1],[59,9,59,10,1],[60,13,60,81,1],[62,13,63,60,1],[63,75,65,43,1],[65,69,65,71,1],[67,13,69,99,1],[70,9,70,10,1],[74,9,74,10,1],[75,13,75,34,1],[77,13,77,66,1],[78,9,78,10,1],[82,9,82,10,1],[83,13,83,67,1],[84,9,84,10,1],[88,9,88,10,1],[89,13,89,119,1],[90,9,90,10,1],[94,9,94,10,1],[95,13,95,36,1],[97,13,97,34,1],[100,9,100,10,1],[107,9,107,10,1],[108,13,108,67,1],[109,9,109,10,1],[113,9,113,10,1],[114,13,114,34,1],[115,13,115,32,1],[117,13,117,67,1],[118,9,118,10,1],[122,9,122,10,1],[123,13,123,43,1],[124,13,124,64,1],[126,13,126,52,1],[128,13,128,34,1],[130,13,130,118,1],[131,9,131,10,1],[135,9,135,10,1],[136,13,136,34,1],[139,13,139,14,1],[140,17,140,38,1],[145,13,145,46,1],[146,13,146,14,1],[148,13,148,14,1],[151,13,151,66,1],[152,9,152,10,1],[156,9,156,10,1],[157,13,157,81,1],[159,13,159,34,1],[161,13,161,20,1],[161,34,161,52,1],[161,22,161,30,1],[162,13,162,14,1],[163,17,165,102,1],[166,13,166,14,1],[161,31,161,33,1],[167,9,167,10,1],[171,9,171,10,1],[172,13,172,43,1],[173,13,173,64,1],[175,13,175,52,1],[177,13,177,97,1],[179,13,179,115,1],[180,9,180,10,1],[185,9,185,10,1],[186,13,186,34,1],[187,13,187,81,1],[193,9,193,10,1],[194,13,194,81,1],[196,13,196,30,1],[202,9,202,10,1],[203,13,203,53,1],[205,13,205,47,1],[206,13,206,70,1],[207,13,207,70,1],[209,13,209,42,1],[210,13,210,51,1],[211,13,211,40,1],[213,13,213,34,1],[220,9,220,10,1],[221,13,221,43,1],[222,13,222,38,1],[227,9,227,10,1],[228,13,228,53,1],[230,13,230,47,1],[231,13,231,70,1],[232,13,232,68,1],[234,13,234,42,1],[235,13,235,51,1],[236,13,236,40,1],[238,13,238,34,1],[239,13,239,30,1],[240,13,240,32,1],[241,13,241,34,1],[242,13,242,30,1],[244,13,244,81,1],[245,13,247,96,1],[249,9,249,10,1],[253,9,253,10,1],[254,13,254,36,1],[256,13,256,81,1],[257,9,257,10,1],[261,9,261,10,1],[262,13,262,91,1],[263,9,263,10,1],[267,9,267,10,1],[269,13,269,34,1],[271,13,271,43,1],[272,13,272,64,1],[274,13,274,52,1],[276,13,276,32,1],[278,13,278,119,1],[279,9,279,10,1],[283,9,283,10,1],[285,13,285,14,1],[286,17,286,36,1],[291,13,291,46,1],[292,13,292,14,1],[294,13,294,14,1],[297,13,297,67,1],[298,9,298,10,1],[302,9,302,10,1],[303,13,303,81,1],[305,13,305,34,1],[306,13,306,32,1],[308,13,308,20,1],[308,34,308,52,1],[308,22,308,30,1],[309,13,309,14,1],[310,17,312,102,1],[313,13,313,14,1],[308,31,308,33,1],[314,9,314,10,1],[319,9,319,10,1],[320,13,320,30,1],[63,60,63,75,1],[65,43,65,69,1]]);
    </script>
  </body>
</html>